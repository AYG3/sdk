/**
 * MarketIn SDK - Minified Version
 * Version: 1.0.1
 * GitHub: https://github.com/ayg3/sdk
 */
!function(e){"use strict";const t={apiEndpoint:"https://api.marketin.now/api/v1/",debug:!0,sessionId:null,affiliateId:null,campaignId:null,brandId:null},n={generateUUID:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),getQueryParam:e=>{const t=new URLSearchParams(window.location.search);return t.get(e)},setCookie:(e,t,n=30)=>{try{const r=new Date(Date.now()+24*n*864e5).toUTCString();let a=`${e}=${encodeURIComponent(t)}; expires=${r}; path=/; SameSite=Lax`;"https:"===window.location.protocol&&(a+="; Secure"),document.cookie=a}catch(e){}},getCookie:e=>{try{const t=document.cookie?document.cookie.split("; "):[];for(const n of t){const[t,r]=n.split("=");if(t===e)return decodeURIComponent(r||"")}}catch(e){}return null},log:e=>{t.debug&&console.log(`[MarketIn SDK] ${e}`)}},r={init:(e={})=>{Object.assign(t,e),e.campaignId&&!t.campaignId&&(t.campaignId=e.campaignId),e.brandId&&(t.brandId=e.brandId),t.sessionId||(t.sessionId=n.generateUUID());const a=n.getQueryParam("aid")||n.getQueryParam("affiliate_id"),i=n.getQueryParam("cid")||n.getQueryParam("campaign_id"),o=n.getQueryParam("pid")||n.getQueryParam("product_id");if(a&&i){t.affiliateId=a,t.campaignId=i;const e=n.getQueryParam("mi_click");r.trackAffiliateClick({affiliateId:a,campaignId:i,productId:o,clickId:e,referrer:document.referrer,landingUrl:window.location.href})}r.trackPageView(),n.log("SDK initialized")},trackPageView:(e={})=>{const a={url:e.url||window.location.href,referrer:e.referrer||document.referrer,sessionId:e.sessionId||t.sessionId,timestamp:e.timestamp||(new Date).toISOString(),userAgent:e.userAgent||navigator.userAgent,screenResolution:e.screenResolution||`${window.screen.width}x${window.screen.height}`,language:e.language||navigator.language,pageTitle:e.pageTitle||document.title,utmSource:e.utmSource??n.getQueryParam("utm_source"),utmMedium:e.utmMedium??n.getQueryParam("utm_medium"),utmCampaign:e.utmCampaign??n.getQueryParam("utm_campaign"),utmTerm:e.utmTerm??n.getQueryParam("utm_term"),utmContent:e.utmContent??n.getQueryParam("utm_content"),campaignId:e.campaignId??t.campaignId??n.getQueryParam("cid")??n.getQueryParam("campaign_id"),affiliateId:e.affiliateId??t.affiliateId??n.getQueryParam("aid")??n.getQueryParam("affiliate_id"),brandId:e.brandId??t.brandId};console.log("log activity data",a),r.sendToAPI("log-activity",a)},trackAffiliateClick:(e,a)=>{try{const i="object"==typeof e?e:{affiliateId:e,campaignId:a},{affiliateId:o,campaignId:c}=i;if(!o||!c)return void n.log("trackAffiliateClick requires both affiliateId and campaignId");t.affiliateId=t.affiliateId||o,t.campaignId=t.campaignId||c;const d=n.getCookie("mi_click"),l=i.clickId||n.getQueryParam("mi_click")||d||n.generateUUID();!d&&l&&n.setCookie("mi_click",l,30);const s={affiliateId:i.affiliateId,campaignId:i.campaignId,productId:i.productId||void 0,clickId:l||void 0,referrer:i.referrer||document.referrer,url:i.landingUrl||window.location.href,sessionId:t.sessionId,timestamp:i.timestamp||(new Date).toISOString(),userAgent:i.userAgent||navigator.userAgent};console.log("affiliate click data from sdk:",s),r.sendToAPI("log-affiliate-click",s),n.log(`Affiliate click tracked: ${o}`)}catch(e){n.log(`Failed to track affiliate click: ${e.message}`)}},sendToAPI:(e,a)=>{try{const i=`${t.apiEndpoint}/${e}/`,o={"Content-Type":"application/json","X-MarketIn-SDK":"1.0.1"};t.campaignId&&(o["X-CAMPAIGN-ID"]=t.campaignId),t.brandId&&(o["X-BRAND-ID"]=t.brandId),n.log(`Sending request to: ${i}`),fetch(i,{method:"POST",headers:o,body:JSON.stringify(a)}).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);return e.json()}).then(e=>{n.log(`API Success: ${JSON.stringify(e)}`)}).catch(e=>{n.log(`API Error: ${e.message}`)})}catch(e){n.log(`Failed to send API request: ${e.message}`)}},crawlPageData:()=>{try{n.log("Starting page data crawl");const e={url:window.location.href,title:document.title,meta:{description:document.querySelector('meta[name="description"]')?.content||"",keywords:document.querySelector('meta[name="keywords"]')?.content||""},products:Array.from(document.querySelectorAll("[data-marketin-product]")).map(e=>({id:e.dataset.marketinProduct,name:e.dataset.marketinProductName||"",price:e.dataset.marketinProductPrice||"0",category:e.dataset.marketinProductCategory||""}))};n.log(`Found ${e.products.length} products to crawl`),e.products.length>0&&n.log(`Product names: ${e.products.map(e=>e.name).join(", ")}`),r.sendToAPI("crawl-data",e)}catch(e){n.log(`Failed to crawl page data: ${e.message}`)}},trackConversion:({eventType:e,value:a=0,currency:i="USD",conversionRef:o,productId:c,metadata:d={},subscriptionId:l,periodNumber:s,planId:u,interval:g,recurringAmount:p,subscriptionStatus:m}={})=>{try{if(!t.campaignId||!t.affiliateId)return void n.log("Conversion skipped: missing campaignId or affiliateId");const f="string"==typeof e&&e.startsWith("subscription");if(!f&&!c)return void n.log("Conversion aborted: productId is required for non-subscription events");const h=`mi_conv_${t.sessionId}_${e}`,y=window.localStorage.getItem(h);if(y&&y===o)return void n.log(`Duplicate conversion ignored for event: ${e}`);const v=c||n.getQueryParam("pid")||n.getQueryParam("product_id"),I={campaignId:parseInt(t.campaignId),affiliateId:parseInt(t.affiliateId),sessionId:t.sessionId,eventType:e,value:a,currency:i,conversionRef:o||n.generateUUID()};v&&(I.productId=v),e&&e.startsWith("subscription")?I.metadata=Object.assign({},d,{subscriptionId:l,periodNumber:s,planId:u,interval:g,recurringAmount:p,subscriptionStatus:m}):Object.keys(d).length&&(I.metadata=d);const w=t.token?"log-conversion":"sdk-log-conversion";r.sendToAPI(w,I),window.localStorage.setItem(h,I.conversionRef),n.log(`Conversion tracked: ${e} ${a} ${i}`)}catch(e){n.log(`Failed to track conversion: ${e.message}`)}},getStatus:()=>({version:"1.0.1",config:{...t},sessionId:t.sessionId,initialized:!!t.sessionId})};e.MarketIn=r}(window);